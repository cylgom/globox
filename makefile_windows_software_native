.POSIX:
NAME = globox.exe
CMD = ./globox.exe

CC = "/c/Program Files (x86)/Microsoft Visual Studio/2019/BuildTools/VC/Tools/MSVC/14.28.29333/bin/Hostx64/x64/cl.exe"
LDFLAGS+= -SUBSYSTEM:windows -ENTRY:mainCRTStartup -DEBUG:FULL -LIBPATH:"/c/Program Files (x86)/Windows Kits/10/Lib/10.0.19041.0/um/x64" -LIBPATH:"/c/Program Files (x86)/Microsoft Visual Studio/2019/BuildTools/VC/Tools/MSVC/14.28.29333/lib/spectre/x64" -LIBPATH:"/c/Program Files (x86)/Windows Kits/10/Lib/10.0.19041.0/ucrt/x64"
LDLIBS+= Gdi32.lib User32.lib shcore.lib dwmapi.lib

DRMEMORY+= -report_max
DRMEMORY+= -1
DRMEMORY+= -report_leak_max
DRMEMORY+= -1
DRMEMORY+= -batch

CFLAGS+= -Z7 -Zc:inline
CFLAGS+= -Isrc
CFLAGS+= -I"/c/Program Files (x86)/Windows Kits/10/Include/10.0.19041.0/ucrt"
CFLAGS+= -I"/c/Program Files (x86)/Windows Kits/10/Include/10.0.19041.0/um"
CFLAGS+= -I"/c/Program Files (x86)/Windows Kits/10/Include/10.0.19041.0/shared"
CFLAGS+= -I"/c/Program Files (x86)/Microsoft Visual Studio/2019/BuildTools/VC/Tools/MSVC/14.28.29333/include"

CFLAGS+= -DGLOBOX_ERROR_LOG_BASIC
CFLAGS+= -DGLOBOX_ERROR_LOG_THROW
CFLAGS+= -DGLOBOX_ERROR_LOG_DEBUG
CFLAGS+= -DGLOBOX_PLATFORM_WINDOWS
CFLAGS+= -DGLOBOX_COMPATIBILITY_WINE
CFLAGS+= -DGLOBOX_COMPILER_MSVC
CFLAGS+= -DUNICODE
CFLAGS+= -D_UNICODE
CFLAGS+= -DWINVER=0x0A00
CFLAGS+= -D_WIN32_WINNT=0x0A00
CFLAGS+= -DCINTERFACE
CFLAGS+= -DCOBJMACROS
CFLAGS+= -DGLOBOX_CONTEXT_SOFTWARE

OBJ+= src/globox.obj
OBJ+= src/globox_error.obj
OBJ+= src/windows/globox_windows.obj
OBJ+= example/software.obj
OBJ+= src/windows/software/globox_windows_software.obj
OBJ+= res/icon/iconpix_pe.obj

bin/$(NAME).exe: $(OBJ)
	mkdir -p $(@D)
	$(CC) -Febin/$(NAME) $^ -link $(LDFLAGS) $(LDLIBS)

res/icon/iconpix.bin:
	make/scripts/pixmap_bin.sh

res/icon/iconpix_pe.obj: res/icon/iconpix.bin
	objcopy -I binary -O pe-x86-64 -B i386:x86-64 \
	--redefine-syms=res/icon/syms.map \
	--rename-section .data=.iconpix \
	$< $@

leak: bin/$(NAME).exe
	@echo "# running Dr.Memory"
	cd bin && drmemory.exe $(DRMEMORY) 2> ../drmemory.log $(CMD)
	less drmemory.log

globox.o: src/globox.c src/globox.h src/globox_error.h
globox_error.o: src/globox_error.c src/globox.h src/globox_error.h
globox_windows.o: src/windows/globox_windows.c globox.h globox_error.h \
 windows/globox_windows.h
software.o: example/software.c globox.h
globox_windows_software.o: src/windows/software/globox_windows_software.c \
 globox.h globox_error.h windows/globox_windows.h \
 windows/software/globox_windows_software.h

.SUFFIXES: .c .obj
.c.obj:
	$(CC) $(CFLAGS) -Fo$@ -c $<

run:
	cd bin && $(CMD)

clean:
	make/scripts/clean.sh

remotes:
	@echo "# registering remotes"
	make/scripts/git_remotes.sh

github:
	@echo "# sourcing submodules from https://github.com"
	make/scripts/git_github.sh

gitea:
	@echo "# sourcing submodules from personal server"
	make/scripts/git_gitea.sh
