.POSIX:
NAME = globox
CMD = wine ./globox.exe

CC = x86_64-w64-mingw32-gcc
LDFLAGS+= 
LDLIBS+= -lgdi32 -ldwmapi -mwindows -lgdi32 -ldwmapi -mwindows -lopengl32

CFLAGS+= -std=c99
CFLAGS+= -pedantic
CFLAGS+= -g
CFLAGS+= -Wall
CFLAGS+= -Wextra
CFLAGS+= -Werror=vla
CFLAGS+= -Werror
CFLAGS+= -Wno-address-of-packed-member
CFLAGS+= -Wno-unused-parameter
CFLAGS+= -Wno-implicit-fallthrough
CFLAGS+= -Wno-cast-function-type
CFLAGS+= -Wno-incompatible-pointer-types
CFLAGS+= -Isrc
CFLAGS+= -Ires/egl_headers

CFLAGS+= -DGLOBOX_ERROR_LOG_BASIC
CFLAGS+= -DGLOBOX_ERROR_LOG_THROW
CFLAGS+= -DGLOBOX_ERROR_LOG_DEBUG
CFLAGS+= -DGLOBOX_PLATFORM_WINDOWS
CFLAGS+= -DGLOBOX_COMPATIBILITY_WINE
CFLAGS+= -DUNICODE
CFLAGS+= -D_UNICODE
CFLAGS+= -DWINVER=0x0A00
CFLAGS+= -D_WIN32_WINNT=0x0A00
CFLAGS+= -DCINTERFACE
CFLAGS+= -DCOBJMACROS
CFLAGS+= -DGLOBOX_CONTEXT_WGL

OBJ+= src/globox.o
OBJ+= src/globox_error.o
OBJ+= src/windows/globox_windows.o
OBJ+= src/windows/wgl/globox_windows_wgl.o
EXAMPLE+= res/icon/iconpix_pe.o
EXAMPLE+= example/wgl.o

bin/$(NAME).exe: $(OBJ) $(EXAMPLE)
	mkdir -p $(@D)
	$(CC) $(LDFLAGS) -o bin/$(NAME) $^ $(LDLIBS)

res/icon/iconpix.bin:
	make/scripts/pixmap_bin.sh

res/icon/iconpix_pe.o: res/icon/iconpix.bin
	objcopy -I binary -O pe-x86-64 -B i386:x86-64 \
	--redefine-syms=res/icon/syms.map \
	--rename-section .data=.iconpix \
	$< $@

bin/$(NAME).dll: $(OBJ)
	mkdir -p $(@D)
	$(CC) $(LDFLAGS) -shared -o $@ $^ $(LDLIBS) -Wl,--out-implib,$(@D)/lib$(NAME).a

globox.o: src/globox.c src/globox.h src/globox_error.h
globox_error.o: src/globox_error.c src/globox.h src/globox_error.h
globox_windows.o: src/windows/globox_windows.c globox.h globox_error.h \
 windows/globox_windows.h
globox_windows_wgl.o: src/windows/wgl/globox_windows_wgl.c globox.h \
 globox_error.h windows/globox_windows.h windows/wgl/globox_windows_wgl.h
wgl.o: example/wgl.c globox.h

run:
	cd bin && $(CMD)

clean:
	make/scripts/clean.sh

remotes:
	@echo "# registering remotes"
	make/scripts/git_remotes.sh
