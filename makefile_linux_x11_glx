.POSIX:
NAME = globox
CMD = ./globox

CC = gcc
LDFLAGS+= 
LDLIBS+= -lGLX -lGLESv2 -lX11-xcb -lxcb -lXrender -lX11 

VALGRIND+= --show-error-list=yes
VALGRIND+= --show-leak-kinds=all
VALGRIND+= --track-origins=yes
VALGRIND+= --leak-check=full
VALGRIND+= --suppressions=../res/valgrind.supp

CFLAGS+= -std=c99
CFLAGS+= -pedantic
CFLAGS+= -g
CFLAGS+= -Wall
CFLAGS+= -Wextra
CFLAGS+= -Werror=vla
CFLAGS+= -Werror
CFLAGS+= -Wno-address-of-packed-member
CFLAGS+= -Wno-unused-parameter
CFLAGS+= -Isrc

CFLAGS+= -DGLOBOX_ERROR_LOG_BASIC
CFLAGS+= -DGLOBOX_ERROR_LOG_THROW
CFLAGS+= -DGLOBOX_ERROR_LOG_DEBUG
CFLAGS+= -DGLOBOX_PLATFORM_X11
CFLAGS+= -DGLOBOX_CONTEXT_GLX

OBJ+= src/globox.o
OBJ+= src/globox_error.o
OBJ+= src/x11/globox_x11.o
OBJ+= src/x11/glx/globox_x11_glx.o
EXAMPLE+= res/icon/iconpix.o
EXAMPLE+= example/glx.o

bin/$(NAME): $(OBJ) $(EXAMPLE)
	mkdir -p $(@D)
	$(CC) $(LDFLAGS) -o $@ $^ $(LDLIBS)

res/icon/iconpix.bin:
	make/scripts/pixmap_bin.sh

res/icon/iconpix.o: res/icon/iconpix.bin
	objcopy -I binary -O elf64-x86-64 -B i386:x86-64 \
	--redefine-syms=res/icon/syms.map \
	--rename-section .data=.iconpix \
	$< $@

leak: bin/$(NAME)
	@echo "# running valgrind"
	cd bin && valgrind $(VALGRIND) 2> ../valgrind.log $(CMD)
	less valgrind.log

bin/$(NAME).so: $(OBJ)
	mkdir -p $(@D)
	$(CC) $(LDFLAGS) -shared -o $@ $^ $(LDLIBS)

bin/$(NAME).a: $(OBJ)
	mkdir -p $(@D)
	ar rcs $@ $^

globox.o: src/globox.c src/globox.h src/globox_error.h
globox_error.o: src/globox_error.c src/globox.h src/globox_error.h
globox_x11.o: src/x11/globox_x11.c globox.h globox_error.h \
 x11/globox_x11.h
globox_x11_glx.o: src/x11/glx/globox_x11_glx.c globox.h globox_error.h \
 x11/globox_x11.h
glx.o: example/glx.c globox.h

run:
	cd bin && $(CMD)

clean:
	make/scripts/clean.sh

remotes:
	@echo "# registering remotes"
	make/scripts/git_remotes.sh
