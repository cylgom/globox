.POSIX:
NAME = globox
CMD = ./globox

CC = gcc
LDFLAGS+= 
LDLIBS+= -lwayland-egl -lwayland-client -lEGL -lGLESv2 
LDLIBS+= -lrt

VALGRIND+= --show-error-list=yes
VALGRIND+= --show-leak-kinds=all
VALGRIND+= --track-origins=yes
VALGRIND+= --leak-check=full
VALGRIND+= --suppressions=../res/valgrind.supp

CFLAGS+= -std=c99
CFLAGS+= -pedantic
CFLAGS+= -g
CFLAGS+= -Wall
CFLAGS+= -Wextra
CFLAGS+= -Werror=vla
CFLAGS+= -Werror
CFLAGS+= -Wno-address-of-packed-member
CFLAGS+= -Wno-unused-parameter
CFLAGS+= -Isrc
CFLAGS+= -Ires/wayland_headers

CFLAGS+= -DGLOBOX_ERROR_LOG_BASIC
CFLAGS+= -DGLOBOX_ERROR_LOG_THROW
CFLAGS+= -DGLOBOX_ERROR_LOG_DEBUG
CFLAGS+= -DGLOBOX_PLATFORM_WAYLAND
CFLAGS+= -DGLOBOX_CONTEXT_EGL

OBJ+= src/globox.o
OBJ+= src/globox_error.o
OBJ+= src/wayland/globox_wayland.o
OBJ+= src/wayland/globox_wayland_callbacks.o
OBJ+= res/wayland_headers/xdg-shell-protocol.o
OBJ+= res/wayland_headers/xdg-decoration-protocol.o
OBJ+= res/wayland_headers/kde-blur-protocol.o
OBJ+= res/wayland_headers/zwp-relative-pointer-protocol.o
OBJ+= res/wayland_headers/zwp-pointer-constraints-protocol.o
OBJ+= src/wayland/egl/globox_wayland_egl.o
OBJ+= src/wayland/egl/globox_wayland_egl_helpers.o
EXAMPLE+= res/icon/iconpix.o
EXAMPLE+= example/egl.o

final: res/wayland_headers bin/$(NAME)

res/wayland_headers:
	make/scripts/wayland_get.sh

bin/$(NAME): $(OBJ) $(EXAMPLE)
	mkdir -p $(@D)
	$(CC) $(LDFLAGS) -o $@ $^ $(LDLIBS)

res/icon/iconpix.bin:
	make/scripts/pixmap_bin.sh

res/icon/iconpix.o: res/icon/iconpix.bin
	objcopy -I binary -O elf64-x86-64 -B i386:x86-64 \
	--redefine-syms=res/icon/syms.map \
	--rename-section .data=.iconpix \
	$< $@

leak: bin/$(NAME)
	@echo "# running valgrind"
	cd bin && valgrind $(VALGRIND) 2> ../valgrind.log $(CMD)
	less valgrind.log

bin/$(NAME).so: $(OBJ)
	mkdir -p $(@D)
	$(CC) $(LDFLAGS) -shared -o $@ $^ $(LDLIBS)

bin/$(NAME).a: $(OBJ)
	mkdir -p $(@D)
	ar rcs $@ $^

globox.o: src/globox.c src/globox.h src/globox_error.h
globox_error.o: src/globox_error.c src/globox.h src/globox_error.h
globox_wayland.o: src/wayland/globox_wayland.c globox.h globox_error.h \
 xdg-shell-client-protocol.h xdg-decoration-client-protocol.h \
 kde-blur-client-protocol.h zwp-relative-pointer-protocol.h \
 zwp-pointer-constraints-protocol.h wayland/globox_wayland.h \
 wayland/globox_wayland_callbacks.h
globox_wayland_callbacks.o: src/wayland/globox_wayland_callbacks.c \
 globox.h globox_error.h wayland/globox_wayland.h \
 wayland/globox_wayland_callbacks.h
xdg-shell-protocol.o: res/wayland_headers/xdg-shell-protocol.c
xdg-decoration-protocol.o: res/wayland_headers/xdg-decoration-protocol.c
kde-blur-protocol.o: res/wayland_headers/kde-blur-protocol.c
zwp-relative-pointer-protocol.o: \
 res/wayland_headers/zwp-relative-pointer-protocol.c
zwp-pointer-constraints-protocol.o: \
 res/wayland_headers/zwp-pointer-constraints-protocol.c
globox_wayland_egl.o: src/wayland/egl/globox_wayland_egl.c globox.h \
 globox_error.h wayland/globox_wayland.h wayland/egl/globox_wayland_egl.h \
 wayland/egl/globox_wayland_egl_helpers.h
globox_wayland_egl_helpers.o: \
 src/wayland/egl/globox_wayland_egl_helpers.c globox.h globox_error.h \
 wayland/globox_wayland.h wayland/egl/globox_wayland_egl.h \
 wayland/egl/globox_wayland_egl_helpers.h
egl.o: example/egl.c globox.h

run:
	cd bin && $(CMD)

clean:
	make/scripts/clean.sh

remotes:
	@echo "# registering remotes"
	make/scripts/git_remotes.sh
